<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>layers-travel - Tatva</title>
    <meta name="description" content="Interactive 3D visualization of how neural network embeddings evolve across layers">
    <meta name="google-site-verification" content="IVG1y4MVA_6MT0wsjk13ooZDQLWXxvYcPXQlmf83MLM" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
    
    <!-- Mermaid.js for diagram rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#ff6b6b',
                primaryTextColor: '#333',
                primaryBorderColor: '#ff6b6b',
                lineColor: '#666',
                sectionBkgColor: '#f8f9fa',
                altSectionBkgColor: '#e9ecef',
                gridColor: '#ddd',
                tertiaryColor: '#f1f3f4'
            }
        });
    </script>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress">
        <div class="scroll-progress-bar" id="scroll-progress-bar"></div>
    </div>
    
    <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">Tatva</a>
        
        <nav class="site-nav">
            <div class="trigger">
                <a class="page-link" href="/">Home</a>
                <!-- <a class="page-link" href="/about">About</a> -->
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-icon theme-icon-light">üåô</span>
                    <span class="theme-icon theme-icon-dark">‚òÄÔ∏è</span>
                </button>
            </div>
        </nav>
    </div>
</header> 
    
    <main class="page-content">
        <div class="wrapper">
            
<article class="post">
    <header class="post-header">
        <h1 class="post-title">layers-travel</h1>
        <p class="post-meta">
            <time datetime="{{ page.date | date_to_xmlschema }}">
                September 16, 2025
            </time>
            
        </p>
    </header>

    <div class="post-content">
        <hr>
<h2>layout: post
title: &quot;3D Layerwise Embedding Evolution: A Journey Through Transformer Representations&quot;
date: 2025-09-16
categories: [machine-learning, visualization, transformers]
tags: [embeddings, neural-networks, pca, 3d-visualization, transformers]
description: &quot;Interactive 3D visualization showing how transformer embeddings evolve through neural network layers&quot;</h2>
<h1>3D Layerwise Embedding Evolution</h1>
<p>This interactive 3D visualization reveals how transformer embeddings evolve through the 25 layers of a neural network. Watch as semantic representations transform from scattered, unstructured patterns in early layers to clearly defined clusters in deeper layers.</p>
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js"></script>

<div class="visualization-wrapper">
    <div class="controls-panel">
        <div class="control-group">
            <label for="dataset-select">Dataset:</label>
            <select id="dataset-select">
                <option value="sentiment_analysis">Sentiment Analysis</option>
                <option value="academic_subjects">Academic Subjects</option>
                <option value="scientific_domains">Scientific Domains</option>
            </select>
        </div>
        
<pre><code>    &lt;div class=&quot;control-group&quot;&gt;
        &lt;label&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;show-trajectories&quot; checked&gt;
            Show Trajectories
        &lt;/label&gt;
    &lt;/div&gt;
    
    &lt;div class=&quot;control-group&quot;&gt;
        &lt;label&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;layer-spacing&quot; checked&gt;
            Enhanced Layer Spacing
        &lt;/label&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;loading-state&quot; class=&quot;status-message&quot;&gt;
    Loading 3D visualization...
&lt;/div&gt;

&lt;div id=&quot;error-state&quot; class=&quot;status-message error&quot; style=&quot;display: none;&quot;&gt;
    Unable to load visualization data. Please check your connection.
&lt;/div&gt;

&lt;div id=&quot;plot-3d&quot; style=&quot;width:100%; height:600px; display:none;&quot;&gt;&lt;/div&gt;

&lt;div id=&quot;dataset-info&quot; class=&quot;info-section&quot; style=&quot;display:none;&quot;&gt;
    &lt;h3&gt;Dataset Statistics&lt;/h3&gt;
    &lt;div class=&quot;stats-container&quot;&gt;
        &lt;div class=&quot;stat-item&quot;&gt;
            &lt;span class=&quot;stat-label&quot;&gt;Total Items:&lt;/span&gt;
            &lt;span class=&quot;stat-value&quot; id=&quot;total-items&quot;&gt;-&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class=&quot;stat-item&quot;&gt;
            &lt;span class=&quot;stat-label&quot;&gt;Categories:&lt;/span&gt;
            &lt;span class=&quot;stat-value&quot; id=&quot;categories-list&quot;&gt;-&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class=&quot;stat-item&quot;&gt;
            &lt;span class=&quot;stat-label&quot;&gt;Layers:&lt;/span&gt;
            &lt;span class=&quot;stat-value&quot;&gt;25 (L0-L24)&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
</div>

<h2>Understanding the Visualization</h2>
<h3>3D Structure</h3>
<ul>
<li><strong>X-axis (PC1)</strong>: First principal component of embeddings</li>
<li><strong>Y-axis (PC2)</strong>: Second principal component of embeddings  </li>
<li><strong>Z-axis</strong>: Layer depth (0-24) through the transformer network</li>
</ul>
<h3>Visual Elements</h3>
<ul>
<li><strong>Colored Points</strong>: Each category has a distinct color (science/math/literature, positive/negative/neutral, etc.)</li>
<li><strong>Trajectory Lines</strong>: Faint lines connecting how individual text samples move through embedding space</li>
<li><strong>Layer Separation</strong>: Vertical spacing shows the progression through network layers</li>
</ul>
<h3>Key Observations</h3>
<h4>Early Layers (0-5)</h4>
<ul>
<li>Embeddings appear relatively mixed and unstructured</li>
<li>Limited semantic separation between categories</li>
<li>Lower explained variance in PCA components</li>
</ul>
<h4>Middle Layers (6-15)</h4>
<ul>
<li>Gradual emergence of category-specific clustering</li>
<li>Increasing separation between semantic groups</li>
<li>Peak explained variance often occurs in this range</li>
</ul>
<h4>Late Layers (16-24)</h4>
<ul>
<li>Clear, distinct clusters for each category</li>
<li>Strong semantic organization</li>
<li>Stable representational structure</li>
</ul>
<h2>Dataset Comparisons</h2>
<h3>Academic Subjects</h3>
<p>Categories: Science, Mathematics, Literature</p>
<ul>
<li>Mathematics concepts cluster tightly in later layers</li>
<li>Science topics show broad but consistent grouping  </li>
<li>Literature maintains distinct semantic space</li>
</ul>
<h3>Sentiment Analysis</h3>
<p>Categories: Positive, Negative, Neutral</p>
<ul>
<li>Clear emotional polarity emerges by layer 10-12</li>
<li>Neutral sentiments occupy intermediate space</li>
<li>Strong linear separability in final layers</li>
</ul>
<h3>Scientific Domains</h3>
<p>Categories: Astronomy, Biology, Physics</p>
<ul>
<li>Domain-specific terminologies create clear boundaries</li>
<li>Physics and astronomy show some overlap (mathematical concepts)</li>
<li>Biology maintains distinct biological/life science cluster</li>
</ul>
<h2>Technical Implementation</h2>
<p>The visualization processes 1,800 data points (24 items √ó 25 layers √ó 3 datasets) in real-time, applying PCA dimensionality reduction while preserving the temporal evolution through network layers.</p>
<style>
.visualization-wrapper {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.controls-panel {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-group label {
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

.control-group select {
    padding: 6px 12px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    background: white;
    font-size: 14px;
    min-width: 160px;
}

.control-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.control-group input[type="checkbox"] {
    transform: scale(1.2);
    margin-right: 5px;
}

.status-message {
    text-align: center;
    padding: 40px;
    font-size: 1.1rem;
    color: #6c757d;
    background: rgba(255,255,255,0.8);
    border-radius: 8px;
}

.status-message.error {
    color: #dc3545;
    background: rgba(248, 215, 218, 0.8);
}

.info-section {
    margin-top: 20px;
    padding: 20px;
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.info-section h3 {
    margin-top: 0;
    color: #495057;
    font-size: 1.2rem;
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: white;
    border-radius: 6px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.stat-label {
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
}

.stat-value {
    font-weight: 700;
    color: #667eea;
    font-size: 1rem;
}

#plot-3d {
    background: rgba(255,255,255,0.95);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}
</style>

<script>
let embeddingsData = null;
let currentDataset = 'academic_subjects';

// Color schemes for each dataset
const colorSchemes = {
    sentiment_analysis: {
        'positive': '#27ae60',
        'negative': '#e74c3c', 
        'neutral': '#3498db'
    },
    academic_subjects: {
        'science': '#e74c3c',
        'mathematics': '#1abc9c',
        'literature': '#3498db'
    },
    scientific_domains: {
        'astronomy': '#9b59b6',
        'biology': '#f39c12',
        'physics': '#e91e63'
    }
};

async function loadVisualizationData() {
    try {
        const response = await fetch('https://tatva.sumityadav.com.np/posts/2025/09/16/layers-travel/all_layerwise_embeddings.json');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        embeddingsData = await response.json();
        
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('plot-3d').style.display = 'block';
        document.getElementById('dataset-info').style.display = 'block';
        
        setupEventListeners();
        renderVisualization();
        updateDatasetInfo();
        
    } catch (error) {
        console.error('Failed to load visualization data:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
    }
}

function setupEventListeners() {
    document.getElementById('dataset-select').addEventListener('change', function(e) {
        currentDataset = e.target.value;
        renderVisualization();
        updateDatasetInfo();
    });
    
    document.getElementById('show-trajectories').addEventListener('change', renderVisualization);
    document.getElementById('layer-spacing').addEventListener('change', renderVisualization);
}

function updateDatasetInfo() {
    if (!embeddingsData || !embeddingsData[currentDataset]) return;
    
    const dataset = embeddingsData[currentDataset];
    document.getElementById('total-items').textContent = dataset.total_items;
    document.getElementById('categories-list').textContent = dataset.categories.join(', ');
}

function renderVisualization() {
    if (!embeddingsData || !embeddingsData[currentDataset]) return;
    
    const dataset = embeddingsData[currentDataset];
    const showTrajectories = document.getElementById('show-trajectories').checked;
    const enhancedSpacing = document.getElementById('layer-spacing').checked;
    const colors = colorSchemes[currentDataset];
    
    // Build trajectory data for each text item
    const trajectoryMap = {};
    
    Object.keys(dataset.layers).forEach(layerKey => {
        const layerIndex = parseInt(layerKey);
        const layerData = dataset.layers[layerKey];
        
        layerData.items.forEach((item, itemIndex) => {
            const uniqueKey = `${item.category}_${itemIndex}`;
            
            if (!trajectoryMap[uniqueKey]) {
                trajectoryMap[uniqueKey] = {
                    category: item.category,
                    text: item.text,
                    coordinates: []
                };
            }
            
            trajectoryMap[uniqueKey].coordinates.push({
                x: item.pca_coordinates.x,
                y: item.pca_coordinates.y,
                z: enhancedSpacing ? layerIndex * 120 : layerIndex * 50,
                layer: layerIndex
            });
        });
    });
    
    let plotTraces = [];
    
    // Create scatter traces for each category
    const categoryGroups = {};
    Object.values(trajectoryMap).forEach(trajectory => {
        const category = trajectory.category;
        
        if (!categoryGroups[category]) {
            categoryGroups[category] = {
                x: [], y: [], z: [],
                text: [], customdata: [],
                mode: 'markers',
                type: 'scatter3d',
                name: category.charAt(0).toUpperCase() + category.slice(1),
                marker: {
                    color: colors[category] || '#95a5a6',
                    size: 5,
                    opacity: 0.8,
                    line: { color: 'rgba(0,0,0,0.1)', width: 0.5 }
                },
                hovertemplate: '<b>%{text}</b><br>' +
                             'PC1: %{x:.1f}<br>' +
                             'PC2: %{y:.1f}<br>' +
                             'Layer: %{customdata}<br>' +
                             '<extra></extra>'
            };
        }
        
        trajectory.coordinates.forEach(coord => {
            categoryGroups[category].x.push(coord.x);
            categoryGroups[category].y.push(coord.y);
            categoryGroups[category].z.push(coord.z);
            categoryGroups[category].text.push(trajectory.text);
            categoryGroups[category].customdata.push(coord.layer);
        });
    });
    
    plotTraces = Object.values(categoryGroups);
    
    // Add trajectory lines if enabled
    if (showTrajectories) {
        Object.values(trajectoryMap).forEach((trajectory, index) => {
            const coords = trajectory.coordinates;
            plotTraces.push({
                x: coords.map(c => c.x),
                y: coords.map(c => c.y),
                z: coords.map(c => c.z),
                mode: 'lines',
                type: 'scatter3d',
                line: {
                    color: colors[trajectory.category] || '#95a5a6',
                    width: 2,
                    opacity: 0.4
                },
                showlegend: false,
                hoverinfo: 'none'
            });
        });
    }
    
    const layout = {
        title: {
            text: `3D Layer-wise Embedding Evolution: ${dataset.description}`,
            font: { size: 16, color: '#2c3e50' }
        },
        scene: {
            xaxis: { 
                title: 'PC1',
                gridcolor: 'rgba(128,128,128,0.3)',
                backgroundcolor: 'rgba(240,240,240,0.1)'
            },
            yaxis: { 
                title: 'PC2',
                gridcolor: 'rgba(128,128,128,0.3)',
                backgroundcolor: 'rgba(240,240,240,0.1)'
            },
            zaxis: { 
                title: 'Layer Index',
                gridcolor: 'rgba(128,128,128,0.3)',
                backgroundcolor: 'rgba(240,240,240,0.1)'
            },
            camera: {
                eye: { x: 1.8, y: 1.8, z: 1.2 },
                center: { x: 0, y: 0, z: 0.3 }
            },
            aspectmode: 'manual',
            aspectratio: { x: 1, y: 1, z: 0.8 },
            bgcolor: 'rgba(248,249,250,0.8)'
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'rgba(255,255,255,0.95)',
            bordercolor: 'rgba(0,0,0,0.1)',
            borderwidth: 1
        },
        margin: { l: 0, r: 0, t: 40, b: 0 },
        paper_bgcolor: 'rgba(0,0,0,0)'
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d'],
        displaylogo: false
    };
    
    Plotly.newPlot('plot-3d', plotTraces, layout, config);
}

// Initialize visualization when page loads
document.addEventListener('DOMContentLoaded', loadVisualizationData);
</script>

<h2>Research Implications</h2>
<p>This 3D visualization demonstrates several key principles of transformer architectures:</p>
<ol>
<li><strong>Hierarchical Representation Learning</strong>: Early layers capture surface-level patterns while deeper layers develop semantic understanding</li>
<li><strong>Emergent Clustering</strong>: Categories naturally separate without explicit supervision</li>
<li><strong>Representation Stability</strong>: Final layers show consistent, structured embeddings suitable for downstream tasks</li>
</ol>
<p>The ability to visualize this transformation provides insights into why transformer models are so effective at natural language understanding tasks - they automatically develop meaningful semantic representations through their layered architecture.</p>

    </div>

    <footer class="post-footer">
        <p><a href="/">&larr; Back to all posts</a></p>
    </footer>
</article> 
        </div>
    </main>
    
    <footer class="site-footer">
    <div class="wrapper">
        <div class="footer-content">
            <p>&copy; 2025 Made with ‚ù§Ô∏è | All rights reserved to <a href="https://sumityadav.com.np" target="_blank">sumityadav.com.np</a></p>
            
                <p>Contact: <a href="mailto:rockerritesh4@gmail.com">rockerritesh4@gmail.com</a></p>
            
        </div>
    </div>
</footer> 
    
    <!-- Theme toggle functionality -->
    <script>
        (function() {
            // Get theme preference from localStorage or default to system preference
            const getThemePreference = () => {
                const stored = localStorage.getItem('theme-preference');
                if (stored) return stored;
                
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            };
            
            // Apply theme to document
            const applyTheme = (theme) => {
                const root = document.documentElement;
                root.classList.remove('light-theme', 'dark-theme');
                
                if (theme !== 'auto') {
                    root.classList.add(`${theme}-theme`);
                }
                
                // Update Mermaid theme if it exists
                if (window.mermaid) {
                    const mermaidTheme = theme === 'dark' || 
                        (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) 
                        ? 'dark' : 'default';
                    
                    mermaid.initialize({ 
                        startOnLoad: true,
                        theme: mermaidTheme,
                        themeVariables: {
                            primaryColor: theme === 'dark' ? '#4da6ff' : '#ff6b6b',
                            primaryTextColor: theme === 'dark' ? '#e0e0e0' : '#333',
                            primaryBorderColor: theme === 'dark' ? '#4da6ff' : '#ff6b6b',
                            lineColor: theme === 'dark' ? '#a0a0a0' : '#666',
                            sectionBkgColor: theme === 'dark' ? '#2a2a2a' : '#f8f9fa',
                            altSectionBkgColor: theme === 'dark' ? '#333' : '#e9ecef',
                            gridColor: theme === 'dark' ? '#333' : '#ddd',
                            tertiaryColor: theme === 'dark' ? '#2a2a2a' : '#f1f3f4'
                        }
                    });
                    
                    // Re-render existing diagrams
                    document.querySelectorAll('.mermaid').forEach(el => {
                        if (el.getAttribute('data-processed')) {
                            el.removeAttribute('data-processed');
                            el.innerHTML = el.getAttribute('data-original') || el.innerHTML;
                        }
                    });
                    mermaid.init(undefined, '.mermaid');
                }
            };
            
            // Toggle theme function
            const toggleTheme = () => {
                const currentTheme = getThemePreference();
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                localStorage.setItem('theme-preference', newTheme);
                applyTheme(newTheme);
            };
            
            // Apply theme on page load
            document.addEventListener('DOMContentLoaded', () => {
                const theme = getThemePreference();
                applyTheme(theme);
                
                // Add click event to theme toggle button
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }
                
                // Store original mermaid content for re-rendering
                document.querySelectorAll('.mermaid').forEach(el => {
                    if (!el.getAttribute('data-original')) {
                        el.setAttribute('data-original', el.innerHTML);
                    }
                });
            });
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                // Only respond to system changes if user hasn't set a manual preference
                if (!localStorage.getItem('theme-preference')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        })();
        
        // Scroll Progress Bar functionality
        (function() {
            const scrollProgressBar = document.getElementById('scroll-progress-bar');
            
            if (!scrollProgressBar) return;
            
            function updateScrollProgress() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrollPercent = (scrollTop / docHeight) * 100;
                
                scrollProgressBar.style.height = Math.min(Math.max(scrollPercent, 0), 100) + '%';
            }
            
            // Update on scroll
            window.addEventListener('scroll', updateScrollProgress, { passive: true });
            
            // Update on resize (in case content changes)
            window.addEventListener('resize', updateScrollProgress, { passive: true });
            
            // Initial update
            updateScrollProgress();
        })();
    </script>
</body>
</html> 