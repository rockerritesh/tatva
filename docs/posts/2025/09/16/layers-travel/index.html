<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>layers-travel - Tatva</title>
    <meta name="description" content="Interactive 3D visualization of how neural network embeddings evolve across layers">
    <meta name="google-site-verification" content="IVG1y4MVA_6MT0wsjk13ooZDQLWXxvYcPXQlmf83MLM" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
    
    <!-- Mermaid.js for diagram rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#ff6b6b',
                primaryTextColor: '#333',
                primaryBorderColor: '#ff6b6b',
                lineColor: '#666',
                sectionBkgColor: '#f8f9fa',
                altSectionBkgColor: '#e9ecef',
                gridColor: '#ddd',
                tertiaryColor: '#f1f3f4'
            }
        });
    </script>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress">
        <div class="scroll-progress-bar" id="scroll-progress-bar"></div>
    </div>
    
    <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">Tatva</a>
        
        <nav class="site-nav">
            <div class="trigger">
                <a class="page-link" href="/">Home</a>
                <!-- <a class="page-link" href="/about">About</a> -->
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-icon theme-icon-light">üåô</span>
                    <span class="theme-icon theme-icon-dark">‚òÄÔ∏è</span>
                </button>
            </div>
        </nav>
    </div>
</header> 
    
    <main class="page-content">
        <div class="wrapper">
            
<article class="post">
    <header class="post-header">
        <h1 class="post-title">layers-travel</h1>
        <p class="post-meta">
            <time datetime="{{ page.date | date_to_xmlschema }}">
                September 16, 2025
            </time>
            
        </p>
    </header>

    <div class="post-content">
        <h1>Visualizing Transformer Layer Embeddings: A Journey Through Neural Network Representations</h1>
<p>This visualization explores how transformer embeddings evolve across different layers of a neural network. We examine three datasets - sentiment analysis, academic subjects, and scientific domains - to understand how semantic representations develop through the layers.</p>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.26.0/plotly.min.js"></script>

<h2>Interactive Layer-wise PCA Visualizations</h2>
<div class="visualization-container">
  <div class="controls">
    <label for="dataset-select">Dataset:</label>
    <select id="dataset-select">
      <option value="sentiment_analysis">Sentiment Analysis</option>
      <option value="academic_subjects">Academic Subjects</option>
      <option value="scientific_domains">Scientific Domains</option>
    </select>
    
<pre><code>&lt;label for=&quot;layer-slider&quot;&gt;Layer:&lt;/label&gt;
&lt;input type=&quot;range&quot; id=&quot;layer-slider&quot; min=&quot;0&quot; max=&quot;24&quot; value=&quot;0&quot;&gt;
&lt;span id=&quot;layer-value&quot;&gt;0&lt;/span&gt;

&lt;button id=&quot;animate-btn&quot;&gt;Animate Through Layers&lt;/button&gt;
</code></pre>
  </div>
  
  <div id="scatter-plot" style="width:100%;height:500px;"></div>
  
  <div class="layer-info">
    <h3>Layer <span id="current-layer">0</span> Statistics</h3>
    <div class="stats-grid">
      <div class="stat">
        <strong>Explained Variance (PC1):</strong>
        <span id="variance-pc1">-</span>%
      </div>
      <div class="stat">
        <strong>Explained Variance (PC2):</strong>
        <span id="variance-pc2">-</span>%
      </div>
      <div class="stat">
        <strong>Total Variance Captured:</strong>
        <span id="total-variance">-</span>%
      </div>
    </div>
  </div>
</div>

<h2>Variance Analysis Across Layers</h2>
<div id="variance-plot" style="width:100%;height:400px;"></div>

<h2>Key Insights</h2>
<h3>Evolution of Semantic Clustering</h3>
<p>The visualizations reveal how semantic representations evolve through transformer layers:</p>
<ol>
<li><strong>Early Layers (0-4)</strong>: Embeddings show relatively low explained variance and mixed clustering</li>
<li><strong>Middle Layers (5-15)</strong>: Gradual emergence of clearer category separation</li>
<li><strong>Later Layers (16-24)</strong>: More distinct clustering with higher explained variance</li>
</ol>
<h3>Dataset-Specific Patterns</h3>
<h4>Sentiment Analysis</h4>
<ul>
<li><strong>Categories</strong>: Positive, Negative, Neutral</li>
<li><strong>Peak separation</strong>: Around layers 10-15</li>
<li><strong>Final layer clustering</strong>: Strong sentiment-based groupings</li>
</ul>
<h4>Academic Subjects</h4>
<ul>
<li><strong>Categories</strong>: Science, Mathematics, Literature</li>
<li><strong>Peak separation</strong>: Around layers 12-18</li>
<li><strong>Final layer clustering</strong>: Clear disciplinary boundaries</li>
</ul>
<h4>Scientific Domains</h4>
<ul>
<li><strong>Categories</strong>: Astronomy, Biology, Physics</li>
<li><strong>Peak separation</strong>: Around layers 8-14</li>
<li><strong>Final layer clustering</strong>: Well-defined domain clusters</li>
</ul>
<h3>Explained Variance Trends</h3>
<p>The explained variance by the first two principal components shows interesting patterns:</p>
<ul>
<li><strong>Layer 0</strong>: Low variance (15-20%), indicating distributed representations</li>
<li><strong>Peak layers</strong>: Middle layers often show highest total variance capture</li>
<li><strong>Final layers</strong>: Variable patterns depending on task complexity</li>
</ul>
<style>
.visualization-container {
  margin: 20px 0;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #f9f9f9;
}

.controls {
  margin-bottom: 20px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

.controls label {
  font-weight: bold;
}

.controls select, .controls input {
  padding: 5px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.controls button {
  padding: 8px 16px;
  background-color: #007acc;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.controls button:hover {
  background-color: #005a99;
}

.layer-info {
  margin-top: 20px;
  padding: 15px;
  background-color: white;
  border-radius: 4px;
  border: 1px solid #ddd;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.stat {
  padding: 8px;
  background-color: #f5f5f5;
  border-radius: 4px;
}
</style>

<script>
// Load the embeddings data
let embeddingsData;

// Fetch the data
fetch('https://tatva.sumityadav.com.np/posts/2025/09/16/layers-travel/all_layerwise_embeddings.json')
  .then(response => response.json())
  .then(data => {
    embeddingsData = data;
    initializeVisualization();
  })
  .catch(error => {
    console.error('Error loading data:', error);
    document.getElementById('scatter-plot').innerHTML = '<p>Error loading visualization data. Please check the data source.</p>';
  });

let currentDataset = 'sentiment_analysis';
let currentLayer = 0;
let isAnimating = false;

function initializeVisualization() {
  // Set up event listeners
  document.getElementById('dataset-select').addEventListener('change', function(e) {
    currentDataset = e.target.value;
    updateVisualization();
    updateVarianceChart();
  });
  
  document.getElementById('layer-slider').addEventListener('input', function(e) {
    currentLayer = parseInt(e.target.value);
    document.getElementById('layer-value').textContent = currentLayer;
    updateVisualization();
  });
  
  document.getElementById('animate-btn').addEventListener('click', function() {
    if (isAnimating) {
      stopAnimation();
    } else {
      startAnimation();
    }
  });
  
  // Initial visualization
  updateVisualization();
  updateVarianceChart();
}

function updateVisualization() {
  if (!embeddingsData) return;
  
  const dataset = embeddingsData[currentDataset];
  const layerData = dataset.layers[currentLayer.toString()];
  
  if (!layerData) return;
  
  // Prepare data for Plotly
  const traces = {};
  const colors = {
    'positive': '#2E8B57',
    'negative': '#DC143C', 
    'neutral': '#4682B4',
    'science': '#FF6B6B',
    'mathematics': '#4ECDC4',
    'literature': '#45B7D1',
    'astronomy': '#96CEB4',
    'biology': '#FECA57',
    'physics': '#FF9FF3'
  };
  
  // Group items by category
  layerData.items.forEach(item => {
    if (!traces[item.category]) {
      traces[item.category] = {
        x: [],
        y: [],
        text: [],
        mode: 'markers',
        type: 'scatter',
        name: item.category.charAt(0).toUpperCase() + item.category.slice(1),
        marker: {
          color: colors[item.category] || '#666666',
          size: 8,
          opacity: 0.7
        }
      };
    }
    
    traces[item.category].x.push(item.pca_coordinates.x);
    traces[item.category].y.push(item.pca_coordinates.y);
    traces[item.category].text.push(item.text);
  });
  
  const plotData = Object.values(traces);
  
  const layout = {
    title: `${dataset.description} - Layer ${currentLayer}`,
    xaxis: {
      title: `PC1 (${(layerData.explained_variance[0] * 100).toFixed(1)}%)`,
      zeroline: true
    },
    yaxis: {
      title: `PC2 (${(layerData.explained_variance[1] * 100).toFixed(1)}%)`,
      zeroline: true
    },
    showlegend: true,
    hovermode: 'closest',
    margin: { t: 50, l: 80, r: 20, b: 80 }
  };
  
  const config = {
    responsive: true,
    displayModeBar: true,
    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
  };
  
  Plotly.newPlot('scatter-plot', plotData, layout, config);
  
  // Update stats
  document.getElementById('current-layer').textContent = currentLayer;
  document.getElementById('variance-pc1').textContent = (layerData.explained_variance[0] * 100).toFixed(2);
  document.getElementById('variance-pc2').textContent = (layerData.explained_variance[1] * 100).toFixed(2);
  document.getElementById('total-variance').textContent = (layerData.total_variance_captured * 100).toFixed(2);
}

function updateVarianceChart() {
  if (!embeddingsData) return;
  
  const dataset = embeddingsData[currentDataset];
  const layers = Array.from({length: 25}, (_, i) => i);
  
  const pc1Variance = layers.map(layer => dataset.layers[layer.toString()].explained_variance[0] * 100);
  const pc2Variance = layers.map(layer => dataset.layers[layer.toString()].explained_variance[1] * 100);
  const totalVariance = layers.map(layer => dataset.layers[layer.toString()].total_variance_captured * 100);
  
  const traces = [
    {
      x: layers,
      y: pc1Variance,
      name: 'PC1 Explained Variance',
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#1f77b4' }
    },
    {
      x: layers,
      y: pc2Variance,
      name: 'PC2 Explained Variance', 
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#ff7f0e' }
    },
    {
      x: layers,
      y: totalVariance,
      name: 'Total Variance Captured',
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#2ca02c', width: 3 }
    }
  ];
  
  const layout = {
    title: `Explained Variance Across Layers - ${dataset.description}`,
    xaxis: {
      title: 'Layer',
      range: [0, 24]
    },
    yaxis: {
      title: 'Explained Variance (%)',
      range: [0, Math.max(...totalVariance) * 1.1]
    },
    showlegend: true,
    margin: { t: 50, l: 80, r: 20, b: 80 }
  };
  
  const config = {
    responsive: true,
    displayModeBar: false
  };
  
  Plotly.newPlot('variance-plot', traces, layout, config);
}

function startAnimation() {
  if (isAnimating) return;
  
  isAnimating = true;
  document.getElementById('animate-btn').textContent = 'Stop Animation';
  
  const animateStep = () => {
    if (!isAnimating) return;
    
    currentLayer = (currentLayer + 1) % 25;
    document.getElementById('layer-slider').value = currentLayer;
    document.getElementById('layer-value').textContent = currentLayer;
    updateVisualization();
    
    setTimeout(animateStep, 500); // 500ms delay between frames
  };
  
  animateStep();
}

function stopAnimation() {
  isAnimating = false;
  document.getElementById('animate-btn').textContent = 'Animate Through Layers';
}
</script>

<h2>Technical Details</h2>
<h3>Data Processing</h3>
<ul>
<li><strong>PCA</strong>: 2-component principal component analysis applied to each layer&#39;s embeddings</li>
<li><strong>Normalization</strong>: Embeddings normalized before PCA transformation</li>
<li><strong>Layers</strong>: 25 transformer layers (0-24) analyzed for each dataset</li>
</ul>
<h3>Datasets</h3>
<ol>
<li><strong>Sentiment Analysis</strong>: 24 text samples across positive/negative/neutral sentiments</li>
<li><strong>Academic Subjects</strong>: 24 text samples across science/mathematics/literature domains  </li>
<li><strong>Scientific Domains</strong>: 24 text samples across astronomy/biology/physics fields</li>
</ol>
<h3>Visualization Features</h3>
<ul>
<li><strong>Interactive scatter plots</strong>: Click and drag to explore, hover for text details</li>
<li><strong>Layer animation</strong>: Observe how clustering evolves through the network</li>
<li><strong>Variance tracking</strong>: Monitor explained variance across layers</li>
<li><strong>Multi-dataset comparison</strong>: Switch between different semantic tasks</li>
</ul>
<p>This analysis provides insights into how transformer models develop increasingly specialized and structured representations of semantic content as information flows through deeper layers of the network.</p>

    </div>

    <footer class="post-footer">
        <p><a href="/">&larr; Back to all posts</a></p>
    </footer>
</article> 
        </div>
    </main>
    
    <footer class="site-footer">
    <div class="wrapper">
        <div class="footer-content">
            <p>&copy; 2025 Made with ‚ù§Ô∏è | All rights reserved to <a href="https://sumityadav.com.np" target="_blank">sumityadav.com.np</a></p>
            
                <p>Contact: <a href="mailto:rockerritesh4@gmail.com">rockerritesh4@gmail.com</a></p>
            
        </div>
    </div>
</footer> 
    
    <!-- Theme toggle functionality -->
    <script>
        (function() {
            // Get theme preference from localStorage or default to system preference
            const getThemePreference = () => {
                const stored = localStorage.getItem('theme-preference');
                if (stored) return stored;
                
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            };
            
            // Apply theme to document
            const applyTheme = (theme) => {
                const root = document.documentElement;
                root.classList.remove('light-theme', 'dark-theme');
                
                if (theme !== 'auto') {
                    root.classList.add(`${theme}-theme`);
                }
                
                // Update Mermaid theme if it exists
                if (window.mermaid) {
                    const mermaidTheme = theme === 'dark' || 
                        (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) 
                        ? 'dark' : 'default';
                    
                    mermaid.initialize({ 
                        startOnLoad: true,
                        theme: mermaidTheme,
                        themeVariables: {
                            primaryColor: theme === 'dark' ? '#4da6ff' : '#ff6b6b',
                            primaryTextColor: theme === 'dark' ? '#e0e0e0' : '#333',
                            primaryBorderColor: theme === 'dark' ? '#4da6ff' : '#ff6b6b',
                            lineColor: theme === 'dark' ? '#a0a0a0' : '#666',
                            sectionBkgColor: theme === 'dark' ? '#2a2a2a' : '#f8f9fa',
                            altSectionBkgColor: theme === 'dark' ? '#333' : '#e9ecef',
                            gridColor: theme === 'dark' ? '#333' : '#ddd',
                            tertiaryColor: theme === 'dark' ? '#2a2a2a' : '#f1f3f4'
                        }
                    });
                    
                    // Re-render existing diagrams
                    document.querySelectorAll('.mermaid').forEach(el => {
                        if (el.getAttribute('data-processed')) {
                            el.removeAttribute('data-processed');
                            el.innerHTML = el.getAttribute('data-original') || el.innerHTML;
                        }
                    });
                    mermaid.init(undefined, '.mermaid');
                }
            };
            
            // Toggle theme function
            const toggleTheme = () => {
                const currentTheme = getThemePreference();
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                localStorage.setItem('theme-preference', newTheme);
                applyTheme(newTheme);
            };
            
            // Apply theme on page load
            document.addEventListener('DOMContentLoaded', () => {
                const theme = getThemePreference();
                applyTheme(theme);
                
                // Add click event to theme toggle button
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }
                
                // Store original mermaid content for re-rendering
                document.querySelectorAll('.mermaid').forEach(el => {
                    if (!el.getAttribute('data-original')) {
                        el.setAttribute('data-original', el.innerHTML);
                    }
                });
            });
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                // Only respond to system changes if user hasn't set a manual preference
                if (!localStorage.getItem('theme-preference')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        })();
        
        // Scroll Progress Bar functionality
        (function() {
            const scrollProgressBar = document.getElementById('scroll-progress-bar');
            
            if (!scrollProgressBar) return;
            
            function updateScrollProgress() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrollPercent = (scrollTop / docHeight) * 100;
                
                scrollProgressBar.style.height = Math.min(Math.max(scrollPercent, 0), 100) + '%';
            }
            
            // Update on scroll
            window.addEventListener('scroll', updateScrollProgress, { passive: true });
            
            // Update on resize (in case content changes)
            window.addEventListener('resize', updateScrollProgress, { passive: true });
            
            // Initial update
            updateScrollProgress();
        })();
    </script>
</body>
</html> 